{
  "label": "Threshold",
  "description": "Evaluates counts produced by an earlier step like `count` or `length` (or by operators that expose `ctx.count`). For each chosen scope it compares the actual count against a user-defined numeric threshold and reports diagnostics when the rule is violated.",
  "requiresContext": {
    "path": "ctx.count",
    "message": "A previous step must populate `ctx.count`. This is usually done by `count`, `length`, or a custom operator."
  },
  "fields": {
    "target": {
      "type": "string",
      "title": "Count target",
      "description": "Which counted entity to evaluate. If omitted, the operator tries to infer the target from the previous step or from the only key inside `ctx.count`.",
      "required": false
    },
    "conditions": {
      "type": "object",
      "title": "Per-scope conditions",
      "description": "Object whose keys are scopes (`line`, `paragraph`, `document`, `endoffile`, `previousstepoutput`) and whose values are comparison rules.",
      "patternProperties": {
        "^(line|paragraph|document|endoffile|previousstepoutput)$": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": [
                "lessthan",
                "lessthanequalto",
                "greaterthan",
                "greaterthanequalto",
                "equalto"
              ],
              "description": "Comparison operator"
            },
            "value": {
              "type": "number",
              "minimum": 0,
              "description": "Numeric threshold value"
            }
          },
          "required": [
            "type",
            "value"
          ],
          "additionalProperties": false
        }
      },
      "minProperties": 1,
      "required": true,
      "additionalProperties": false
    },
    "level": {
      "type": "string",
      "title": "Severity",
      "description": "Diagnostics severity emitted when the threshold is violated.",
      "enum": [
        "warning",
        "error"
      ],
      "default": "warning",
      "required": false
    }
  },
  "additionalProperties": false,
  "unevaluatedProperties": false,
  "produces": {
    "target": "<same value as `target` field>",
    "data": {
      "violations": "Object with scope keys and per-scope violation arrays"
    },
    "contextWrites": [
      "ctx.diagnostics"
    ],
    "diagnosticsSeverity": [
      "warning",
      "error"
    ]
  },
  "example": {
    "operator": "threshold",
    "target": "heading",
    "conditions": {
      "document": {
        "type": "lessthan",
        "value": 10
      },
      "line": {
        "type": "greaterthan",
        "value": 0
      }
    },
    "level": "warning"
  }
}